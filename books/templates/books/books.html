{% extends 'base.html' %}
{% load static %}

{% block title%}Books | {{ block.super}}{% endblock %}
{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">
<link rel="stylesheet" href="{% static 'css/map-style.css' %}">
<link rel="stylesheet" href="{% static 'css/leaflet-search.css' %}">


<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
crossorigin=""/>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
crossorigin=""></script>

<script src='https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />

<script src="{% static 'js/leaflet-control.min.js' %}"></script>

{% endblock head_extra %}

{% block content %}

<div class="container">
    </div>
    <div id="mapid"></div>
    <div class="container">
    <script>
    // var mymap = L.map('mapid').setView([51.505, -0.09], 13);

        

        var mymap = new L.Map('mapid', {zoom: 9, center: new L.latLng([40,13]) });	//set center from first location

        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox.streets',
            accessToken: 'pk.eyJ1IjoiYnJpYW5jYWZmZXkiLCJhIjoiY2pkczJycjl5MmhqbTMzbzQ3bHJuaHA3aiJ9.cvRYYPNjQJVpFjdUcmIHzA'
        }).addTo(mymap);

        var circle = L.circle([51.508, -0.11], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 500
        }).addTo(mymap);

        // var map = new L.Map('map', {zoom: 9, center: new L.latLng(data[0].loc) });	//set center from first location

        var markersLayer = new L.LayerGroup();	//layer contain searched elements
        
        mymap.addLayer(markersLayer);

        var controlSearch = new L.Control.Search({
            position:'topright',		
            layer: markersLayer,
            initial: false,
            zoom: 12,
            marker: false
        });

        mymap.addControl( controlSearch );

        function populateMap(data){
            for(i in data) {
            var title = data[i].title,	//value searched
                loc = data[i].loc,		//position found
                marker = new L.Marker(new L.latLng(loc), {title: title} );//se property searched
            marker.bindPopup('<a href="'+ title + '">' + title + '</a>' );
            markersLayer.addLayer(marker);
            }
        }

        $.ajax({
            type: "GET",
            url: "/books/map_data",
            success: function(data){
                var books = data["data"]
                var new_lat = books[0].loc[0]
                var new_lon = books[0].loc[1]
                // mymap.panTo(new L.LatLng(new_lat,new_lon));
                mymap.setView([0, 0], 3);
                populateMap(books)
            }
            });
        



    </script>
    
    <br/>

    <p>Here are all available books</p>
    <ol>
    {% for book in books%}
        <li>
            {{ book.title }}
        </li>
    {% endfor %}
    </ol>

</div>



{% endblock %}